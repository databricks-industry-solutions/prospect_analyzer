name: Prospect Analyzer CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

env:
  DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
  DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Bundle
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Databricks CLI
      run: |
        curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
        echo "$HOME/.databricks/bin" >> $GITHUB_PATH
    
    - name: Configure Databricks CLI
      run: |
        echo "[DEFAULT]" > ~/.databrickscfg
        echo "host = $DATABRICKS_HOST" >> ~/.databrickscfg
        echo "token = $DATABRICKS_TOKEN" >> ~/.databrickscfg
    
    - name: Validate Bundle Configuration
      run: |
        databricks bundle validate --target dev
    
    - name: Check Notebook Format
      run: |
        python .github/scripts/convert_notebooks.py

  deploy-dev:
    runs-on: ubuntu-latest
    name: Deploy to Development
    needs: validate
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Databricks CLI
      run: |
        curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
        echo "$HOME/.databricks/bin" >> $GITHUB_PATH
    
    - name: Configure Databricks CLI
      run: |
        echo "[DEFAULT]" > ~/.databrickscfg
        echo "host = $DATABRICKS_HOST" >> ~/.databrickscfg
        echo "token = $DATABRICKS_TOKEN" >> ~/.databrickscfg
    
    - name: Deploy Bundle
      run: |
        databricks bundle deploy --target dev
    
    - name: Run Integration Tests
      run: |
        echo "Running prospect analyzer pipeline test..."
        # Add specific pipeline tests here

  deploy-prod:
    runs-on: ubuntu-latest
    name: Deploy to Production
    needs: validate
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Databricks CLI  
      run: |
        curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
        echo "$HOME/.databricks/bin" >> $GITHUB_PATH
    
    - name: Configure Databricks CLI
      run: |
        echo "[DEFAULT]" > ~/.databrickscfg
        echo "host = $DATABRICKS_HOST" >> ~/.databrickscfg
        echo "token = $DATABRICKS_TOKEN" >> ~/.databrickscfg
    
    - name: Deploy to Production
      run: |
        databricks bundle deploy --target prod
      env:
        BUNDLE_VAR_catalog: "main"
        BUNDLE_VAR_schema: "prospect_analyzer"